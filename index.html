<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Management System</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7f9;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      background: #1f1f1f;
      color: white;
      padding: 12px;
      margin: 0;
    }
    .tab {
      display: flex;
      justify-content: space-around;
      background: #333;
      padding: 10px;
    }
    .tab button {
      background: none;
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
    }
    .tab button.active {
      color: silver;
      text-decoration: underline;
    }
    .container {
      padding: 10px;
    }
    .client-card {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
    }
    .filed-tag {
      background: #d4edda;
      color: #155724;
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
      font-size: 13px;
      margin-top: 5px;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      width: 90%;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background: #333;
      color: white;
      border: none;
    }
    button:hover {
      background: #555;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Client Management System</h1>

  <div class="tab">
    <button id="tabAdd" onclick="showTab('addClient')">Add Client</button>
    <button id="tabList" onclick="showTab('clientList')">Client List</button>
    <button id="tabRem" class="active" onclick="showTab('reminders')">Reminders</button>
  </div>

  <div class="container hidden" id="addClient">
    <h3>Add Client</h3>
    <input id="name" placeholder="Client Name">
    <input id="mobile" placeholder="Mobile Number">
    <input id="email" placeholder="Email ID">
    <input id="category" placeholder="Category (GST/ITR)">
    <input id="dob" type="date" placeholder="Date of Birth">
    <button onclick="addClient()">Submit</button>
  </div>

  <div class="container hidden" id="clientList">
    <h3>Client List</h3>
    <button onclick="refreshData()">âŸ³ Refresh</button>
    <select id="filterCategory" onchange="renderClients()">
      <option value="All">All</option>
      <option value="GST">GST</option>
      <option value="ITR">ITR</option>
    </select>
    <div id="clients"></div>
  </div>

  <div class="container" id="reminders">
    <h3>Reminders</h3>
    <button onclick="refreshData()">âŸ³ Refresh</button>
    <div id="reminderList"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKuD852vBtPRkyH28D3IjXrvRwSIJNPj2a5262uNSQdHoxkrJp4JsgjWbOQ9TDNxkmPg/exec";
    let clients = [];

    function showTab(tab) {
      document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
      document.querySelectorAll('.tab button').forEach(b => b.classList.remove('active'));
      document.getElementById('tab' + (tab.charAt(0).toUpperCase() + tab.slice(1))).classList.add('active');

      // When switching tabs, render from cached data instantly
      if (tab === 'clientList') renderClients();
      if (tab === 'reminders') renderReminders();
    }

    async function fetchData() {
      const res = await fetch(SCRIPT_URL + "?action=get");
      clients = await res.json();
      resetFiledMonthly();
      renderClients();
      renderReminders();
    }

    function refreshData() {
      fetchData();
    }

    function addClient() {
      const password = prompt("Enter password to add client:");
      if (password !== "9876") return alert("Incorrect password!");

      const data = {
        action: "add",
        name: document.getElementById('name').value,
        mobile: document.getElementById('mobile').value,
        email: document.getElementById('email').value,
        category: document.getElementById('category').value.toUpperCase(),
        dob: document.getElementById('dob').value,
      };
      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(data),
      }).then(() => {
        alert("Client added successfully!");
        fetchData();
      });
    }

    function markFiled(index) {
      const password = prompt("Enter password to mark filed:");
      if (password !== "9876") return alert("Incorrect password!");

      clients[index].filed = true;
      clients[index].filedMonth = new Date().getMonth();
      renderClients();
      renderReminders();
    }

    function renderClients() {
      const filter = document.getElementById('filterCategory').value;
      const list = document.getElementById('clients');
      list.innerHTML = '';
      clients
        .filter(c => filter === "All" || c.category === filter)
        .forEach((c, i) => {
          const filedStatus = c.filed ? `<span class='filed-tag'>Filed âœ…</span>` : `<button onclick='markFiled(${i})'>Mark as Filed</button>`;
          const div = document.createElement('div');
          div.className = "client-card";
          div.innerHTML = `
            <b>${c.name}</b><br>
            Category: ${c.category}<br>
            Mobile: ${c.mobile}<br>
            Email: ${c.email}<br>
            DOB: ${c.dob}<br>
            ${filedStatus}
          `;
          list.appendChild(div);
        });
    }

    function renderReminders() {
      const today = new Date();
      const reminderList = document.getElementById('reminderList');
      reminderList.innerHTML = '';

      const weekEnd = new Date();
      weekEnd.setDate(today.getDate() + 7);

      const weeklyReminders = clients.filter(c => {
        const dob = new Date(c.dob);
        const dobThisYear = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        const isBirthday = dobThisYear >= today && dobThisYear <= weekEnd;

        let isReturn = false;
        if (c.category === "GST") {
          const gstDates = [11, 20];
          isReturn = gstDates.some(d => {
            const returnDate = new Date(today.getFullYear(), today.getMonth(), d);
            return returnDate >= today && returnDate <= weekEnd;
          });
        } else if (c.category === "ITR") {
          const itrDate = new Date(today.getFullYear(), 7, 30);
          isReturn = itrDate >= today && itrDate <= weekEnd;
        }

        const filedThisMonth = c.filed && c.filedMonth === today.getMonth();
        return !filedThisMonth && (isReturn || isBirthday);
      });

      if (weeklyReminders.length === 0) {
        reminderList.innerHTML = "<p>No reminders this week âœ…</p>";
        return;
      }

      weeklyReminders.forEach(c => {
        const msg = encodeURIComponent(`Hello ${c.name}, this is a friendly reminder for your ${c.category} return or birthday!`);
        const whatsapp = `https://wa.me/91${c.mobile}?text=${msg}`;
        const email = `mailto:${c.email}?subject=Reminder&body=${msg}`;
        const div = document.createElement('div');
        div.className = "client-card";
        div.innerHTML = `
          <b>${c.name}</b><br>
          Category: ${c.category}<br>
          Mobile: ${c.mobile}<br>
          Email: ${c.email}<br>
          <a href="${whatsapp}" target="_blank">ðŸ“± WhatsApp</a> |
          <a href="${email}" target="_blank">ðŸ“§ Email</a>
        `;
        reminderList.appendChild(div);
      });
    }

    function resetFiledMonthly() {
      const currentMonth = new Date().getMonth();
      clients.forEach(c => {
        if (c.filedMonth !== currentMonth) c.filed = false;
      });
    }

    // Fetch once at startup for instant rendering
    fetchData().then(() => showTab("reminders"));
  </script>
</body>
</html>
