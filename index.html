<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Management System</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f9f9f9;
    color: #222;
    margin: 0;
    padding: 20px;
  }
  h1 { text-align: center; color: #333; }
  .container {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  input, select, button {
    padding: 8px;
    margin: 6px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 10px 8px;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
    word-break: break-word;
  }
  th { background: #f3f3f3; }
  @media (max-width: 600px) {
    table, thead, tbody, th, td, tr { display: block; }
    tr {
      margin-bottom: 15px;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    td {
      display: flex;
      justify-content: space-between;
      border: none;
      padding: 6px 0;
    }
    td::before {
      content: attr(data-label);
      font-weight: bold;
      color: #555;
    }
  }
  .reminder-section {
    margin-top: 30px;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
</style>
</head>
<body>
<div class="container">
  <h1>Client Management System</h1>

  <!-- Add Client Form -->
  <h3>Add New Client</h3>
  <form id="clientForm" onsubmit="return addClient()">
    <input type="text" id="name" placeholder="Client Name" required>
    <select id="type" required>
      <option value="">Select Client Type</option>
      <option value="GST">GST Client</option>
      <option value="ITR">ITR Client</option>
    </select>
    <input type="text" id="mobile" placeholder="Mobile No">
    <input type="email" id="email" placeholder="Email ID">
    <input type="text" id="aadhar" placeholder="Aadhar No">
    <input type="text" id="pan" placeholder="PAN No">
    <input type="text" id="gst" placeholder="GST No">
    <input type="text" id="portalId" placeholder="Portal User ID">
    <input type="text" id="portalPass" placeholder="Portal Password">
    <input type="date" id="dob" placeholder="Date of Birth">
    <button type="submit">âž• Add Client</button>
  </form>
  <hr>

  <!-- Filter -->
  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px;">
    <select id="filterType" onchange="filterClients()">
      <option value="all">All Clients</option>
      <option value="GST">GST Clients</option>
      <option value="ITR">ITR Clients</option>
    </select>
    <button onclick="fetchData()">ðŸ”„ Refresh</button>
  </div>

  <!-- Table -->
  <table id="clientTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Mobile</th>
        <th>Email</th>
        <th>Filed?</th>
        <th>Last Filed On</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Reminders -->
  <div class="reminder-section">
    <h2>ðŸ“… Reminders (This Week)</h2>
    <div id="reminderList">Loading...</div>
  </div>
</div>

<script>
const sheetURL = "https://script.google.com/macros/s/AKfycbzKuD852vBtPRkyH28D3IjXrvRwSIJNPj2a5262uNSQdHoxkrJp4JsgjWbOQ9TDNxkmPg/exec";
let allClients = [];

async function fetchData(){
  const res = await fetch(sheetURL);
  const data = await res.json();
  allClients = data;
  renderTable(data);
  renderReminders(data);
}

function renderTable(clients){
  const tbody = document.querySelector('#clientTable tbody');
  tbody.innerHTML = '';
  clients.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Name">${c.name}</td>
      <td data-label="Type">${c.type}</td>
      <td data-label="Mobile">${c.mobile}</td>
      <td data-label="Email">${c.email}</td>
      <td data-label="Filed?">
        <input type="checkbox" ${c['Filed Status'] === 'Yes' ? 'checked' : ''} onchange="markFiled('${c.name}','${c.type}',this.checked)">
      </td>
      <td data-label="Last Filed">${c['Last Filed On'] || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function filterClients(){
  const type = document.getElementById('filterType').value;
  if(type === "all") renderTable(allClients);
  else renderTable(allClients.filter(c => c.type.toLowerCase() === type.toLowerCase()));
}

// Mark as Filed
async function markFiled(name, type, checked){
  const filedStatus = checked ? "Yes" : "No";
  const today = new Date();
  const lastFiledOn = today.toDateString();
  await fetch(sheetURL, {
    method: 'POST',
    body: JSON.stringify({
      action: "update",
      name,
      filedStatus,
      lastFiledOn
    }),
    headers: { 'Content-Type': 'application/json' }
  });
  alert(`${name}'s ${type} marked as filed âœ…`);
  fetchData();
}

// Add new client
async function addClient(){
  const form = document.getElementById("clientForm");
  const client = {
    name: form.name.value,
    type: form.type.value,
    mobile: form.mobile.value,
    email: form.email.value,
    aadhar: form.aadhar.value,
    pan: form.pan.value,
    gst: form.gst.value,
    portalId: form.portalId.value,
    portalPass: form.portalPass.value,
    dob: form.dob.value
  };
  await fetch(sheetURL, {
    method: 'POST',
    body: JSON.stringify(client),
    headers: { 'Content-Type': 'application/json' }
  });
  alert("âœ… Client added successfully!");
  form.reset();
  fetchData();
  return false;
}

// Reminders (unchanged)
function renderReminders(rem){
  const rdiv = document.getElementById('reminderList');
  rdiv.innerHTML = '';
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - 3);
  const weekEnd = new Date(today);
  weekEnd.setDate(today.getDate() + 7);
  const reminders = [];
  rem.forEach(c => {
    if(c.type === "GST"){
      const d11 = new Date(today.getFullYear(), today.getMonth(), 11);
      const d20 = new Date(today.getFullYear(), today.getMonth(), 20);
      [d11, d20].forEach(d => {
        if(d >= weekStart && d <= weekEnd){
          reminders.push({name:c.name, date:d.toDateString(), type:"GST Return Due"});
        }
      });
    }
    if(c.type === "ITR"){
      const d30 = new Date(today.getFullYear(), 7, 30);
      if(d30 >= weekStart && d30 <= weekEnd){
        reminders.push({name:c.name, date:d30.toDateString(), type:"ITR Filing Due"});
      }
    }
    if(c.dob){
      const dob = new Date(c.dob);
      const bd = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
      if(bd >= weekStart && bd <= weekEnd){
        reminders.push({name:c.name, date:bd.toDateString(), type:"ðŸŽ‚ Birthday"});
      }
    }
  });
  if(reminders.length === 0){
    rdiv.innerHTML = '<p>No reminders this week ðŸŽ‰</p>';
    return;
  }
  reminders.forEach(r => {
    const div = document.createElement('div');
    div.innerHTML = `<b>${r.name}</b> â€” ${r.type} (${r.date})<hr>`;
    rdiv.appendChild(div);
  });
}

fetchData();
</script>
</body>
</html>